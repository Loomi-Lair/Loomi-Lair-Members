name: PR éªŒè¯

on:
  pull_request_target:
    branches:
      - main

jobs:
  validate:
    name: éªŒè¯æˆå‘˜æ•°æ®
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate member files
        id: validate
        run: |
          echo "## ğŸ” éªŒè¯ç»“æœ" >> $GITHUB_STEP_SUMMARY
          if npm run validate; then
            echo "âœ… æ‰€æœ‰æˆå‘˜æ–‡ä»¶éªŒè¯é€šè¿‡ï¼" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Test build
        run: |
          echo "## ğŸ”¨ æ„å»ºæµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          npm run build
          echo "âœ… æ„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- æˆå‘˜æ•°é‡: $(cat dist/members.json | grep -c '"id":')" >> $GITHUB_STEP_SUMMARY

      - name: Comment PR
        if: steps.validate.outputs.status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const members = JSON.parse(fs.readFileSync('dist/members.json', 'utf8'));
            const memberCount = members.length;

            const comment = `## âœ… éªŒè¯é€šè¿‡ï¼

            ğŸ‰ ä½ çš„æˆå‘˜æ•°æ®å·²é€šè¿‡éªŒè¯ï¼

            **ğŸ“Š å½“å‰ç»Ÿè®¡ï¼š**
            - æ€»æˆå‘˜æ•°ï¼š${memberCount} äºº

            **âœ¨ ä¸‹ä¸€æ­¥ï¼š**
            åˆå¹¶æ­¤ PR åï¼Œæ•°æ®å°†è‡ªåŠ¨æ„å»ºå¹¶å‘å¸ƒã€‚

            ---
            *è‡ªåŠ¨ç”Ÿæˆ by Loomi Lair Bot*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
