name: PR éªŒè¯

on:
  pull_request_target:
    branches:
      - main

jobs:
  validate:
    name: éªŒè¯æˆå‘˜æ•°æ®
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}:${{ github.event.pull_request.base.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate PR changes
        id: validate_pr
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          BASE_BRANCH: origin/${{ github.event.pull_request.base.ref }}
        run: |
          echo "## ğŸ” PR å˜æ›´éªŒè¯" >> $GITHUB_STEP_SUMMARY
          if node scripts/validate-pr.js; then
            echo "âœ… PR å˜æ›´éªŒè¯é€šè¿‡ï¼" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ PR éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Validate all member files
        id: validate_all
        if: steps.validate_pr.outputs.status == 'success'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ” å®Œæ•´æ€§éªŒè¯" >> $GITHUB_STEP_SUMMARY
          if npm run validate; then
            echo "âœ… æ‰€æœ‰æˆå‘˜æ–‡ä»¶éªŒè¯é€šè¿‡ï¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ å®Œæ•´æ€§éªŒè¯å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Test build
        if: steps.validate_all.conclusion == 'success'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ”¨ æ„å»ºæµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          npm run build
          echo "âœ… æ„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          MEMBER_COUNT=$(cat dist/members.json | grep -c '"id":')
          echo "- æ€»æˆå‘˜æ•°ï¼š${MEMBER_COUNT} äºº" >> $GITHUB_STEP_SUMMARY

      - name: Post welcome comment
        if: steps.validate_pr.outputs.is_new_member == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const memberName = '${{ steps.validate_pr.outputs.member_name }}';
            const memberId = '${{ steps.validate_pr.outputs.member_id }}';
            const memberIntro = '${{ steps.validate_pr.outputs.member_intro }}';
            const memberAvatar = '${{ steps.validate_pr.outputs.member_avatar }}';
            const memberGithub = '${{ steps.validate_pr.outputs.member_github }}';

            const comment = `## ä½ å¥½ï¼Œ${memberName}ï¼

            <img src="${memberAvatar}" width="100" height="100" style="border-radius: 50%;" />

            ğŸ‰ **æ¬¢è¿åŠ å…¥ Loomi Lair ç¤¾åŒºï¼**

            **ï¿½ ä½ çš„ä¿¡æ¯ï¼š**
            - ğŸ†” ID: \`${memberId}\`
            - ğŸ“ ç®€ä»‹: ${memberIntro}
            - ğŸ”— GitHub: ${memberGithub}

            **âœ… éªŒè¯çŠ¶æ€ï¼š**
            - âœ… PR å˜æ›´æ£€æŸ¥é€šè¿‡
            - âœ… æ•°æ®æ ¼å¼éªŒè¯é€šè¿‡
            - âœ… å®Œæ•´æ€§éªŒè¯é€šè¿‡
            - âœ… æ„å»ºæµ‹è¯•é€šè¿‡

            **âœ¨ ä¸‹ä¸€æ­¥ï¼š**
            åˆå¹¶æ­¤ PR åï¼Œä½ çš„ä¿¡æ¯å°†è‡ªåŠ¨åŠ å…¥åˆ°æˆå‘˜åˆ—è¡¨ä¸­ï¼

            ---
            *ğŸ¤– è‡ªåŠ¨ç”Ÿæˆ by Loomi Lair Bot*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
